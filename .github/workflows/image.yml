name: "Build Kubernetes OS image"

env:
  IMAGE_NAME: "kubeos"
  REGISTRY: "quay.io/acardace"

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
    paths:
      - 'Containerfile'
      - 'config/build-config.yaml'
      - 'rootfs/**'
      - 'scripts/**'
      - '.github/workflows/image.yml'
  push:
    branches:
      - main
    paths:
      - 'Containerfile'
      - 'config/build-config.yaml'
      - 'rootfs/**'
      - 'scripts/**'
      - '.github/workflows/image.yml'
  schedule:
    # Daily at 2 AM UTC
    - cron: '0 2 * * *'

permissions: read-all

# Prevent multiple workflow runs from racing to ensure that pushes are made
# sequentially for the main branch. Also cancel in progress workflow runs for
# pull requests only.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  build-push-image:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Install yq
        run: |
          sudo apt-get update
          sudo apt-get install -y yq

      - name: Create auth.json from secret
        env:
          QUAY_AUTH_JSON: ${{ secrets.QUAY_AUTH_JSON }}
        run: |
          if [ -n "$QUAY_AUTH_JSON" ]; then
            mkdir -p rootfs/usr/lib/ostree
            echo "$QUAY_AUTH_JSON" > rootfs/usr/lib/ostree/auth.json
          fi

      - name: Extract build configuration
        id: config
        run: |
          KUBERNETES_VERSION=$(yq -r '.kubernetes_version' config/build-config.yaml)
          SUBNET_PREFIX=$(yq -r '.network.subnet_prefix' config/build-config.yaml)
          NODE_IP=$(yq -r '.network.node_ip' config/build-config.yaml)
          GATEWAY_IP=$(yq -r '.network.gateway_ip' config/build-config.yaml)
          DNS_IP=$(yq -r '.network.dns_ip' config/build-config.yaml)
          CLUSTER_NAME=$(yq -r '.network.cluster_name' config/build-config.yaml)
          BACKUP_DISK=$(yq -r '.disks.backup' config/build-config.yaml)
          MEDIA_DISK=$(yq -r '.disks.media' config/build-config.yaml)

          echo "kubernetes_version=${KUBERNETES_VERSION}" >> $GITHUB_OUTPUT
          echo "subnet_prefix=${SUBNET_PREFIX}" >> $GITHUB_OUTPUT
          echo "node_ip=${NODE_IP}" >> $GITHUB_OUTPUT
          echo "gateway_ip=${GATEWAY_IP}" >> $GITHUB_OUTPUT
          echo "dns_ip=${DNS_IP}" >> $GITHUB_OUTPUT
          echo "cluster_name=${CLUSTER_NAME}" >> $GITHUB_OUTPUT
          echo "backup_disk=${BACKUP_DISK}" >> $GITHUB_OUTPUT
          echo "media_disk=${MEDIA_DISK}" >> $GITHUB_OUTPUT

          echo "Building with Kubernetes ${KUBERNETES_VERSION}"

      - name: Build container image
        uses: redhat-actions/buildah-build@v2
        with:
          image: ${{ env.IMAGE_NAME }}
          tags: latest ${{ steps.config.outputs.kubernetes_version }}
          containerfiles: Containerfile
          layers: true
          oci: true
          build-args: |
            KUBERNETES_VERSION=${{ steps.config.outputs.kubernetes_version }}
            SUBNET_PREFIX=${{ steps.config.outputs.subnet_prefix }}
            NODE_IP=${{ steps.config.outputs.node_ip }}
            GATEWAY_IP=${{ steps.config.outputs.gateway_ip }}
            DNS_IP=${{ steps.config.outputs.dns_ip }}
            CLUSTER_NAME=${{ steps.config.outputs.cluster_name }}
            BACKUP_DISK=${{ steps.config.outputs.backup_disk }}
            MEDIA_DISK=${{ steps.config.outputs.media_disk }}
            GIT_COMMIT=${{ github.sha }}

      - name: Push image to Quay.io
        uses: redhat-actions/push-to-registry@v2
        if: (github.event_name == 'push' || github.event_name == 'schedule') && github.ref == 'refs/heads/main'
        with:
          username: ${{ secrets.BOT_USERNAME }}
          password: ${{ secrets.BOT_PASSWORD }}
          image: ${{ env.IMAGE_NAME }}
          registry: ${{ env.REGISTRY }}
          tags: latest ${{ steps.config.outputs.kubernetes_version }}
